<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Стили таблицы */
        body {
            background-color: rgb(107, 102, 100);
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        /* Стили для таблицы */
        table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
        }
        th, td
        {
            text-align: center;
            border: 2px solid #000000; /* Добавляем границы к ячейкам */
            color: #45a049;
            font-size: 20px;
            min-width: 100px;
            position: relative;
        }

        tr {
            /* Увеличиваем высоту строк */
            height: 50px;
        }

        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f7f7f7;
        }

        td {
            text-align: center; /* Выравнивание содержимого ячейки по центру */
            background-color: #6b6664;
            color: white;
            font-weight: bold;
        }

        /* Стили для выпадающего меню */
        td select
        {
            width: 70%;
            padding: 3px;
            font-size: 18px;
            border: 3px solid #ddd;
            border-radius: 6px;
            background-color: #ffffff;
            transition: border-color 0.3s;
        }

        td select:hover {
            border-color: black;
        }

        td select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .table-menu h1
        {
            align-content: center;
            position: fixed;
            left: 45%;
            margin: 5px;
            z-index: 2;
            font-family: Arial, sans-serif;
            font-size: 35px;
            color: #4CAF50;
        }

        .floating-buttons button {
            padding: 10px;
            border: none;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            font-size: 18px;
            border-radius: 50%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
        }
        .floating-buttons button:hover {
            background-color: #45a049;
        }

        /* Кнопки меню (предыдущий стиль) */
        .table-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #f2f2f2;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 20px;
            padding: 10px;
            z-index: 1;
        }

        /* Контейнер для ссылок справа в верхнем углу */
        .social-links {
            gap: 10px;
            position: absolute;
            top: 10px;
            right: 20px;
            display: flex;
        }

        /* Контейнер для кнопок управления слева в верхнем углу */
        .control-buttons {
            top: 10px;
            left: 20px;
            gap: 10px;
            display: flex;
        }

        /* Стили для кнопок управления */
        .control-buttons button
        {
            padding: 14px;
            background-color: #4CAF50;
            color: white;
            font-size: 18px;
            border: none;
            border-radius: 35%;
            box-shadow: 0 2px 8px black;
            transition: background-color 0.3s ease;
        }

        .control-buttons button:hover
        {
            background-color: #45a049;
        }

        /* Стили для ссылок */
        .social-links a
        {
            display: inline-block;
            padding: 14px;
            background-color: #4CAF50;
            color: white;
            font-size: 18px;
            text-decoration: none;
            border-radius: 35%;
            box-shadow: 0 2px 8px black;
            transition: background-color 0.3s ease;
        }

        .social-links a:hover
        {
            background-color: #45a049;
        }

        .context-menu
        {
            position: fixed;
            z-index: 2;
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            display: none;
            padding: 5px;
        }

        .context-menu button
        {
            display: block;
            padding: 5px;
            border: none;
            background-color: transparent;
            cursor: pointer;
        }

        .context-menu button:hover
        {
            background-color: #f2f2f2;
        }

        .help-panel
        {
            max-width: 1200px; /* Adjust the width as needed */
            padding: 20px; /* Increase padding for better spacing */
            border: 2px solid black; /* Add a border with the color you like */
            border-radius: 10px; /* Add rounded corners */
            background-color: #fff; /* Set a background color */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Add a subtle shadow */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 4; /* Make sure it's above other elements */
        }

        .help-keyword {
            font-weight: bold;
            color: #4CAF50;
        }

        /* Close button styles */
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            border: none;
            background-color: transparent;
            font-size: 24px;
            color: #333;
            cursor: pointer;
        }

        .confirmation-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 3;
        }

        .confirmation-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center; /* Add this line */
            z-index: 4; /* Make sure it's above other elements */
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
        }

        .confirm-button,
        .cancel-button
        {
            padding: 10px 20px;
            margin: 0 10px;
            font-size: 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .confirm-button
        {
            background-color: #4CAF50;
            color: white;
        }

        .cancel-button
        {
            background-color: #ccc;
            color: #333;
        }

        .backdrop
        {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            z-index: 3; /* Задний фон должен быть над всеми остальными элементами */
            display: none; /* Начальное состояние - скрыто */
        }

        .invalid-cell
        {
            background-color: rgba(255, 0, 0, 0.5); /* Чуть темнее красный цвет */
            transition: background-color 8s ease; /* Плавная анимация на 8 секунд */
        }

        .invalid-cell.fade-out
        {
            background-color: #6b6664; /* Обратный цвет (исчезновение) */
        }

        .notification
        {
            position: fixed;
            bottom: -100px; /* Начальная позиция уведомления */
            left: 50%;
            transform: translateX(-50%);
            width: 300px; /* Ширина уведомления */
            padding: 15px 20px;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            font-size: 18px; /* Размер текста уведомления */
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
            z-index: 1000;
            cursor: pointer;
        }

        /* Анимация появления */
        .notification.show
        {
            opacity: 1;
            bottom: 20px; /* Конечная позиция уведомления */
            transition: opacity 0.3s, bottom 0.3s;
        }

        /* Анимация исчезновения */
        .notification.hide
        {
            opacity: 0;
            bottom: -100px; /* Начальная позиция уведомления */
            transition: opacity 0.3s, bottom 0.3s;
        }

    </style>
</head>
<body>
<div class="backdrop" id="backdrop"></div>

<div class="notification" id="notification"></div>

<div class="help-panel" id="helpPanel">
    <button class="close-button" onclick="closeHelpPanel()">&times;</button>
    <p>Here's how to use the tool:</p>
    <p>
        To add a new row, click the <span class="help-keyword">Add row</span> button. Fill in the required values.
        For the <span class="help-keyword">Direction</span> column, choose between <span class="help-keyword">0</span> (Backward)
        and <span class="help-keyword">1</span> (Forward).
    </p>
    <p>
        Use the <span class="help-keyword">Import table</span> button to import data, and the <span class="help-keyword">Save table</span>
        button to save your changes. The <span class="help-keyword">Clear table</span> button removes all rows.
    </p>
    <p>
        When you're ready, click the <span class="help-keyword">Start</span> button to begin, and the <span class="help-keyword">Stop</span>
        button to pause. If you have questions, refer to our <span class="help-keyword">YouTube</span>, <span class="help-keyword">Gmail</span>,
        or <span class="help-keyword">Telegram</span> for support.
    </p>
</div>

<!-- Confirmation Window -->
<div class="confirmation-panel" id="confirmationPanel">
    <div class="confirmation-content">
        <span class="close-button" onclick="closeConfirmationPanel()">&times;</span>
        <p id="confirmationMessage"></p>
        <button class="confirm-button" onclick="OnConfirm()">Yes</button>
        <button class="cancel-button" onclick="closeConfirmationPanel()">No</button>
    </div>
</div>

<!-- Error Panel -->
<div class="confirmation-panel" id="errorPanel">
    <div class="confirmation-content">
        <span class="close-button" onclick="closeErrorPanel()">&times;</span>
        <p id="errorMessage"></p>
        <button class="confirm-button" onclick="closeErrorPanel()">OK</button>
    </div>
</div>

<h1>Queue</h1>
<table id="myTable">
    <tr>
        <th data-required="true">Step</th>
        <th data-required="true">Engine ID</th>
        <th data-required="true">Direction</th>
        <th data-required="true">Start Speed</th>
        <th data-required="true">End Speed</th>
        <th data-required="false">Engine ID</th>
        <th data-required="false">Start speed</th>
        <th data-required="false">End Speed</th>
    </tr>
</table>

<!-- Кнопки меню (новый стиль) -->
<div class="table-menu" id="tableMenu">
    <div class="social-links">
        <a href="https://www.youtube.com/channel/UCS1C2KKheFF0BDf8AMKQ6Qw" target="_blank" title="YouTube"><i class="fab fa-youtube"></i></a>
        <a href="mailto:serginio1963@gmail.com" target="_blank" title="Gmail"><i class="fab fa-google"></i></a>
        <a href="https://t.me/serginius" target="_blank" title="Telegram"><i class="fab fa-telegram"></i></a>
    </div>

    <h1>CNC Tool </h1>

    <div class="control-buttons">
        <button onclick="addRow()" title="Add row"><i class="fas fa-plus"></i></button>
        <button onclick="importTable()" title="Import table"><i class="fas fa-file-import"></i></button>
        <button onclick="exportTable()" title="Save table"><i class="fas fa-save"></i></button>
        <button onclick="clearTable()" title="Clear table"><i class="fas fa-trash"></i></button>
        <button onclick="start()" title="Start"><i class="fas fa-play"></i></button>
        <button onclick="stop()" title="Stop"><i class="fas fa-stop"></i></button>
        <button onclick="help()" title="Help"><i class="fas fa-question"></i></button>
    </div>
</div>

<input type="file" id="fileInput" style="display: none" accept=".txt">

<!-- Контекстное меню -->
<div class="context-menu" id="contextMenu">
    <button onclick="deleteRow(event)">Удалить строку</button>
</div>

<script>

    function preventNonNumericInput(event) {
        var charCode = event.which ? event.which : event.keyCode;

        if (charCode !== 8 && (charCode < 48 || charCode > 57) && charCode !== 46)
        {
            event.preventDefault();
        }
    }

    document.getElementById("myTable").addEventListener("contextmenu", function (event) {
        event.preventDefault(); // Предотвращаем стандартное контекстное меню браузера
        var contextMenu = document.getElementById("contextMenu");
        contextMenu.style.display = "block";
        contextMenu.style.left = event.clientX + "px";
        contextMenu.style.top = event.clientY + "px";

        // Определение, на какую строку был сделан щелчок
        var targetRow = event.target.closest("tr");

        if (targetRow && targetRow !== this.rows[0])
        {
            contextMenu.dataset.rowIndex = targetRow.rowIndex;
        }
    });

    // Обработчик события click для скрытия контекстного меню
    document.addEventListener("click", function (event)
    {
        var contextMenu = document.getElementById("contextMenu");

        if (!event.target.closest(".context-menu"))
        {
            contextMenu.style.display = "none";
        }
    });

    // Добавляем функцию удаления строки
    function deleteRow(event)
    {
        var contextMenu = document.getElementById("contextMenu");
        var rowIndex = contextMenu.dataset.rowIndex;
        var table = document.getElementById("myTable");

        if (rowIndex && rowIndex > 0)
        {
            table.deleteRow(rowIndex);
        }
        contextMenu.style.display = "none";
    }

    function addRow() {
        var table = document.getElementById("myTable");
        var row = table.insertRow(-1); // Вставляем строку в конец таблицы (-1).
        var colCount = table.rows[0].cells.length; // Получаем количество столбцов в таблице.

        for (var i = 0; i < colCount; i++) {
            var cell = row.insertCell(i);
            cell.innerHTML = ""; // Значение по умолчанию - "0".
            cell.setAttribute("contenteditable", "true"); // Делаем ячейку редактируемой.
            cell.addEventListener("keydown", preventNonNumericInput);

            if (i === 2) // Если это ячейка "Direction"
            {
                cell.setAttribute("contenteditable", "false");
                var selectElement = document.createElement("select");
                selectElement.classList.add("direction-select"); // Добавим класс для стилизации

                var option0 = document.createElement("option");
                option0.value = "0";
                option0.text = "0";
                option0.title = "backward";
                selectElement.appendChild(option0);

                var option1 = document.createElement("option");
                option1.value = "1";
                option1.text = "1";
                option1.title = "forward";
                selectElement.appendChild(option1);

                cell.innerHTML = ""; // Очищаем содержимое ячейки
                cell.appendChild(selectElement);
            }
        }
    }

    let notificationCounter = 0;

    function showNotification(text)
    {
        var notification = document.createElement('div');
        notification.classList.add('notification');
        notification.id = 'notification-' + notificationCounter;
        notification.onclick = function()
        {
            hideNotification(notification.id);
        };

        notification.innerHTML = '<div>' + text + '</div>';
        document.body.appendChild(notification);

        setTimeout(function() {
            notification.classList.add('show');
        }, 0);

        setTimeout(function() {
            hideNotification(notification.id);
        }, 4000);

        notificationCounter++;
    }

    function hideNotification(notificationId) {
        var notification = document.getElementById(notificationId);
        if (notification) {
            notification.classList.remove('show');
            notification.classList.add('hide');

            setTimeout(function() {
                notification.remove();
            }, 1000);
        }
    }

    let helpPanel = document.getElementById("helpPanel");


    help();
    function help()
    {
        var backdrop = document.getElementById("backdrop");
        backdrop.style.display = "block";
        helpPanel.style.display = "block";
        document.body.style.overflow = "hidden";
    }

    function closeHelpPanel()
    {
        var backdrop = document.getElementById("backdrop");
        backdrop.style.display = "none";
        helpPanel.style.display = "none";
        document.body.style.overflow = "auto"; // Restore scrolling
    }

    function start()
    {
        const content = GetContent();

        if(content === "") return;

        const startEvent = new CustomEvent('startEvent', { detail: content });
        document.dispatchEvent(startEvent);
    }

    function stop()
    {
        const stopEvent = new Event('stopEvent');
        document.dispatchEvent(stopEvent);
    }

    document.addEventListener('startEvent', function(event)
    {
        let content = event.detail;
        console.log('startEvent', content);
        showNotification("Started");
    });

    document.addEventListener('stopEvent', function(event)
    {
        console.log('stopEvent');
        showNotification("Stopped");
    });

    let confirmationFunction = null;

    function confirmImport()
    {
        var confirmationPanel = document.getElementById("confirmationPanel");
        if (confirmationPanel.style.display === "block")
        {
            closeConfirmationPanel();
        }

        importFromFile();
    }


    function importFromFile()
    {
        const fileInput = document.getElementById('fileInput');
        fileInput.click();
    }

    document.getElementById('fileInput').addEventListener('change', handleFileSelect, false);

    function handleFileSelect(event)
    {
        const file = event.target.files[0];

        if (file)
        {
            const reader = new FileReader();
            reader.onload = function (e)
            {
                const contents = e.target.result;
                updateTableFromText(contents);
            };
            reader.readAsText(file);
        }

        document.getElementById('fileInput').value = '';
    }

    function updateTableFromText(text)
    {
        clear();

        const table = document.getElementById('myTable');
        const rows = text.trim().split(';'); // Разделяем текст на строки

        // Пропускаем первую строку (заголовок таблицы)
        for (let i = 0; i < rows.length; i++)
        {
            const rowText = rows[i];
            let rowIndex = i + 1;

            if(rowText.includes("!")) break;

            addRow();
            const cells = rowText.split(','); // Разделяем строку на ячейки

            for (let j = 0; j < cells.length; j++)
            {
                let cellText = cells[j];
                let cell = table.rows[rowIndex].cells[j];

                if(j === 2)
                {
                    const selectElement = cell.querySelector(".direction-select");
                    selectElement.value = cellText;
                }
                else
                {
                    cell.textContent = cellText;
                }
            }
        }

        showNotification("Successfully imported");
    }

    function importTable()
    {
        confirmationFunction = confirmImport;

        if (document.getElementById("myTable").rows.length > 1)
        {
            openConfirmationPanel("Are you sure you want to import new table?");
        }
        else
        {
            confirmationFunction();
        }
    }

    function confirmClearTable()
    {
        var confirmationPanel = document.getElementById("confirmationPanel");
        if (confirmationPanel.style.display === "block")
        {
            closeConfirmationPanel();
        }

        clear();

        showNotification("Table cleared");
    }

    function clear()
    {
        const table = document.getElementById("myTable");

        for (let i = table.rows.length - 1; i > 0; i--)
        {
            table.deleteRow(i);
        }
    }

    function clearTable()
    {
        confirmationFunction = confirmClearTable;

        if (document.getElementById("myTable").rows.length > 1)
        {
            openConfirmationPanel("Are you sure you want to clear the table?");
        }
        else
        {
            confirmationFunction();
        }
    }

    function OnConfirm()
    {
        confirmationFunction();
    }

    function openConfirmationPanel(message)
    {
        var backdrop = document.getElementById("backdrop");
        var confirmationPanel = document.getElementById("confirmationPanel");
        var confirmationMessage = document.getElementById("confirmationMessage");
        backdrop.style.display = "block";
        confirmationMessage.textContent = message;
        confirmationPanel.style.display = "block";
    }

    function closeConfirmationPanel()
    {
        var backdrop = document.getElementById("backdrop");
        var confirmationPanel = document.getElementById("confirmationPanel");
        backdrop.style.display = "none";
        confirmationPanel.style.display = "none";
    }


    const invalidCells = [];

    function exportTable()
    {
        let content = GetContent();

        if(content === "") return;

        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'table_data.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        showNotification("Data saved");
    }

    function GetContent()
    {
        const table = document.getElementById('myTable');
        let content = '';

        if(table.rows.length <= 1) return "";

        validateTable();

        if (invalidCells.length > 0)
        {
            showErrors("Please correct the highlighted cells.");
            return "";
        }

        for (let i = 1; i < table.rows.length; i++)
        {
            const row = table.rows[i];
            const countOfCells = countNonEmptyCells(row);

            for (let j = 0; j < countOfCells; j++)
            {
                let cellElement = row.cells[j];
                let cellValue;

                if(j === 2)
                {
                    const selectElement = cellElement.querySelector(".direction-select");
                    cellValue = selectElement.value;
                }
                else
                {
                    cellValue = cellElement.textContent.trim();
                }

                content += cellValue;

                if (j !== countOfCells - 1 && cellValue !== "")
                {
                    content += ',';
                }
            }

            if (i !== table.rows.length - 1)
            {
                content += ';\n';
            }
            else
            {
                content += ';!';
            }
        }

        return content;
    }

    function validateTable()
    {
        invalidCells.length = 0;

        const table = document.getElementById('myTable');
        for (let i = 1; i < table.rows.length; i++)
        {
            const row = table.rows[i];

            for (let j = 0; j < 5; j++)
            {
                let cellElement = row.cells[j];
                let cellData;

                if(j === 2)
                {
                    const selectElement = cellElement.querySelector(".direction-select");
                    cellData = selectElement.value;
                }
                else
                {
                    cellData = cellElement.textContent.trim();
                }

                if (cellData === "")
                {
                    invalidCells.push({row: i, cell: j});
                }
            }

            let content5 = row.cells[5].textContent.trim();
            let content6 = row.cells[6].textContent.trim();
            let content7 = row.cells[7].textContent.trim();

            if (content5 !== "" || content6 !== "" || content7 !== "")
            {
                if(content5 === "") invalidCells.push({row: i, cell: 5});
                if(content6 === "") invalidCells.push({row: i, cell: 6});
                if(content7 === "") invalidCells.push({row: i, cell: 7});
            }
        }
    }

    function countNonEmptyCells(row)
    {
        let count = 0;

        for (let j = 0; j < row.cells.length; j++)
        {
            let cellElement = row.cells[j];
            let cellData;

            if(j === 2)
            {
                const selectElement = cellElement.querySelector(".direction-select");
                cellData = selectElement.value;
            }
            else
            {
                cellData = cellElement.textContent.trim();
            }


            if (cellData !== "")
            {
                count++;
            }
        }

        return count;
    }

    function showErrors(message)
    {
        openErrorPanel(message);

        const table = document.getElementById("myTable");
        for (const cellInfo of invalidCells) {
            const row = cellInfo.row;
            const cellIndex = cellInfo.cell;
            const rowElement = table.rows[row];
            const cellElement = rowElement.cells[cellIndex];

            cellElement.classList.add("invalid-cell");
        }

        setTimeout(function () {
            for (const cellInfo of invalidCells) {
                const row = cellInfo.row;
                const cellIndex = cellInfo.cell;
                const rowElement = table.rows[row];
                const cellElement = rowElement.cells[cellIndex];

                cellElement.classList.add("fade-out");

                setTimeout(function () {
                    cellElement.classList.remove("invalid-cell", "fade-out");
                }, 3000); // Удалить классы через 8 секунд
            }
        }, 3000); // Добавить класс "fade-out" через 100 миллисекунд после добавления "invalid-cell"
    }

    function openErrorPanel(message) {
        const errorPanel = document.getElementById('errorPanel');
        const errorMessage = document.getElementById('errorMessage');
        const backdrop = document.getElementById('backdrop');

        backdrop.style.display = 'block';
        errorMessage.textContent = message;
        errorPanel.style.display = 'block';
    }

    function closeErrorPanel() {
        const errorPanel = document.getElementById('errorPanel');
        const backdrop = document.getElementById('backdrop');
        const errorCells = document.querySelectorAll('.error-cell');

        errorCells.forEach(cell => cell.classList.remove('error-cell'));
        backdrop.style.display = 'none';
        errorPanel.style.display = 'none';
    }
</script>

</body>
</html>